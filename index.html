<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Forum Builder（结构风格 + 字段开关 + 自定义模板 + 富文本）</title>
  <style>
    :root{
      --bg:#fafafa;--card:#fff;--bd:#e6e6e6;--txt:#111;--muted:#666;
      --r:14px;--mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--txt)}
    .wrap{max-width:1280px;margin:0 auto;padding:16px;display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:14px}
    h1{font-size:18px;margin:0 0 10px}
    label{display:block;font-size:12px;color:#333;margin:10px 0 6px}
    input, textarea, button, select{font:inherit}
    input, textarea, select{width:100%;border:1px solid #ddd;border-radius:12px;padding:10px;background:#fff;outline:none}
    textarea{min-height:110px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    button{border:1px solid #ddd;background:#fff;border-radius:12px;padding:10px 12px;cursor:pointer}
    button.primary{border-color:#111;background:#111;color:#fff}
    button.danger{border-color:#b00020;color:#b00020}
    button:disabled{opacity:.45;cursor:not-allowed}
    .hint{margin:10px 0 0;color:var(--muted);font-size:12px;line-height:1.6}
    .optRow{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #ddd;border-radius:999px;font-size:12px;color:var(--muted)}
    .pill strong{color:#111}
    .mini{width:180px}
    .miniSm{width:120px}
    .status{margin-top:10px;font-size:12px;color:var(--muted)}
    .status.ok{color:#0a7a2f}
    .status.warn{color:#b00020}

    /* 顶部小Tabs */
    .segRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .segBtn{
      padding:9px 12px;border-radius:999px;border:1px solid #ddd;background:#fff;
      font-size:12px;cursor:pointer;user-select:none
    }
    .segBtn.active{border-color:#111;background:#111;color:#fff}

    details.postItem{border:1px solid #eee;border-radius:var(--r);padding:10px;margin-top:12px;background:#fff}
    details.postItem[open]{border-color:#ddd}
    summary.postSum{list-style:none;cursor:pointer;display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    summary.postSum::-webkit-details-marker{display:none}

    /* summary 左侧：选择框 + 文本 */
    .sumLeft{display:flex;gap:10px;align-items:flex-start;min-width:0}
    .sumPick{
      width:18px;height:18px;margin-top:2px;flex:0 0 auto;
      accent-color:#111;
    }
    .sumText{min-width:0}
    .sumMeta{font-size:12px;color:var(--muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:680px}
    .sumSnippet{font-size:12px;color:#444;margin-top:6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .sumBtns{display:flex;gap:8px;flex:0 0 auto}
    .tinyBtn{padding:8px 10px;border-radius:10px;font-size:12px}
    .editArea{margin-top:10px;padding-top:10px;border-top:1px dashed #e5e5e5}
    .small{font-size:12px;color:var(--muted)}
    .dangerText{color:#b00020}
    .invalidInput{border-color:#b00020 !important; box-shadow:0 0 0 2px rgba(176,0,32,.08)}

    .previewBox{border:1px dashed #ccc;border-radius:var(--r);padding:12px;background:#fff}
    .mono{font-family:var(--mono);font-size:12px}

    /* Wizard */
    .wizardMask{
      position:fixed;inset:0;background:rgba(0,0,0,.45);
      display:none;z-index:999;
      overflow:auto;padding:16px;
      -webkit-overflow-scrolling:touch;
      touch-action:pan-y;
    }
    .wizard{
      max-width:980px;width:100%;
      background:#fff;border-radius:18px;border:1px solid #e5e5e5;
      margin:0 auto;
      max-height:calc(100vh - 32px);
      display:flex;flex-direction:column;
      overflow:hidden;
    }
    .wizHead{padding:14px 16px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between;flex:0 0 auto}
    .wizBody{
      padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:16px;
      overflow:auto;flex:1 1 auto;
      -webkit-overflow-scrolling:touch;
      touch-action:pan-y;
    }
    .wizCol{border:1px solid #eee;border-radius:14px;padding:12px}
    .wizTitle{margin:0 0 8px 0;font-size:14px}
    .chkGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .wizFoot{
      padding:14px 16px;border-top:1px solid #eee;display:flex;gap:10px;justify-content:flex-end;
      flex:0 0 auto;background:#fff;position:sticky;bottom:0;
    }
    .wizPreview{border:1px dashed #ccc;border-radius:14px;padding:12px;min-height:220px;background:#fafafa}
    .tag{display:inline-block;font-size:12px;border:1px solid #ddd;border-radius:999px;padding:2px 8px;color:#555;margin-right:6px;margin-top:6px}

    /* 富文本编辑器 */
    .rteBar{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0 8px}
    .rteBar button{padding:6px 9px;border-radius:10px;font-size:12px}
    .rte{
      border:1px solid #ddd;border-radius:12px;padding:10px;min-height:120px;background:#fff;
      outline:none;white-space:normal
    }
    .rte[data-placeholder]:empty:before{content: attr(data-placeholder);color:#999}

    /* 视图容器（右侧） */
    .rightView{display:none}
    .rightView.active{display:block}

    /* 解决按钮文字出框：只调字号+允许换行，不改变布局 */
    .btns button{
      white-space: normal !important;
      word-break: break-word;
      height: auto;line-height: 1.15;
      padding: 8px 10px;
      font-size: 13px;
      text-align:center;
    }

    /* 模块卡片（左侧内部模块） */
    .module{
      border:1px solid #eee;border-radius:14px;padding:12px;margin-top:12px;background:#fff;
    }
    .moduleHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;
    }
    .moduleHead strong{font-size:13px}
    .moduleGrid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px}
    .subCard{
      border:1px solid #eee;border-radius:14px;padding:10px;background:#fff;
    }
    .subCardTitle{font-size:12px;color:#333;font-weight:700;margin-bottom:6px}
    .subActions{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .fileRow{display:flex;flex-wrap:wrap;gap:10px;align-items:center}

    /* =======================
       手机：Tab + Dock（不遮挡）
       ======================= */
    @media (max-width: 768px){
      :root{ --safe-b: env(safe-area-inset-bottom, 0px); --safe-t: env(safe-area-inset-top, 0px); }

      .wrap{ grid-template-columns: 1fr; padding: 10px; padding-bottom: calc(104px + var(--safe-b)); }
      .card{ padding: 10px; }
      .row{ grid-template-columns: 1fr; }
      .wizBody{ grid-template-columns: 1fr; }
      input, textarea, select{ font-size: 16px; }
      .previewBox{ max-height: 340px; overflow: auto; }
      .btns button{ font-size: 12px; padding: 8px 8px; }

      /* 手机上：只显示一个卡片，用视图切换 */
      .card.previewCard{ display:none; }
      body[data-view="preview"] .card.editorCard{ display:none; }
      body[data-view="preview"] .card.previewCard{ display:block; }

      .moduleGrid2{grid-template-columns:1fr}

      /* Dock：高度更紧凑，避免遮挡 */
      .appDock{
        position: fixed; left: 0; right: 0; bottom: 0;
        z-index: 998;
        padding: 8px 10px calc(8px + var(--safe-b));
        background: rgba(255,255,255,.92);
        backdrop-filter: blur(10px);
        border-top: 1px solid #e9e9e9;
      }
      .dockInner{max-width: 1280px; margin: 0 auto; display: grid; grid-template-columns: 1fr; gap: 8px;}
      .dockTop{display:flex;gap:8px;align-items:center;justify-content:space-between;}
      .dockTabs{display:flex;gap:8px;align-items:center;justify-content:flex-start;flex-wrap:wrap;}
      .dockTab{
        padding: 9px 11px;border-radius:999px;border:1px solid #ddd;background:#fff;
        font-size: 12px;cursor:pointer;user-select:none
      }
      .dockTab.active{border-color:#111;background:#111;color:#fff}
      .dockRight{display:flex;gap:8px;align-items:center}
      .dockBtn{
        padding: 9px 11px;border-radius:12px;border:1px solid #ddd;background:#fff;
        font-size: 12px;cursor:pointer;white-space:nowrap
      }
      .dockBtn.primary{border-color:#111;background:#111;color:#fff}
      .dockActions{display:flex;gap:8px;flex-wrap:wrap}
    }
  </style>
</head>

<body>
  <!-- Wizard -->
  <div class="wizardMask" id="wizardMask" role="dialog" aria-modal="true">
    <div class="wizard">
      <div class="wizHead">
        <div>
          <strong>初始化设置</strong>
          <span class="tag">结构风格</span><span class="tag">字段开关</span><span class="tag">导出方式</span><span class="tag">时间格式</span><span class="tag">随机ID</span>
        </div>
        <button class="tinyBtn" id="btnCloseWiz" type="button">关闭</button>
      </div>

      <div class="wizBody">
        <div class="wizCol">
          <h3 class="wizTitle">1) 选择“结构风格”（不依赖CSS）</h3>
          <select id="wizStyle">
            <option value="classic">Classic：昵称/ID ｜ 时间/#楼层</option>
            <option value="splitmeta">SplitMeta：昵称/ID    时间/#楼层（分侧）</option>
            <option value="compact">Compact：全部信息压一行</option>
            <option value="bubble">Bubble：引用/正文分块</option>
            <option value="custom">Custom：自定义每层楼 HTML 模板（占位符）</option>
          </select>

          <div id="customTplBox" style="display:none; margin-top:10px;">
            <label>自定义：每层楼 HTML 模板</label>
            <textarea id="wizCustomPostTpl" class="mono" placeholder="粘贴单层楼HTML，并使用占位符：{{name}} {{uid}} {{time}} {{floor}} {{quote}} {{quote_by}} {{body}}"></textarea>
            <p class="hint">
              占位符：{{name}} {{uid}} {{time}} {{floor}} {{quote}} {{quote_by}} {{body}}<br/>
              quote/body 为富文本 HTML；其它为纯文本（已转义）。字段未勾选时占位符替换为空字符串。<br/>
              TXT 的 custom 会把 quote/body 转成纯文本再替换。
            </p>
          </div>

          <h3 class="wizTitle" style="margin-top:14px;">2) 选择导出方式</h3>
          <select id="wizExport">
            <option value="ao3_html">导出 AO3 HTML（下载）</option>
            <option value="txt">导出 TXT（下载纯文本）</option>
          </select>

          <h3 class="wizTitle" style="margin-top:14px;">3) 时间格式</h3>
          <div class="optRow">
            <label class="pill" style="cursor:pointer;">
              <input type="checkbox" id="wizShowYear" />
              显示/允许输入年份
            </label>
            <span class="small">时制：</span>
            <select id="wizClockMode" class="mini">
              <option value="24h">24 小时制</option>
              <option value="12h">12 小时制（需 AM/PM）</option>
            </select>
          </div>
          <p class="hint">
            24h：2026-02-09 23:58:10 或 02-09 23:58<br/>
            12h：2026-02-09 11:58 PM 或 02-09 11:58 AM
          </p>

          <h3 class="wizTitle" style="margin-top:14px;">4) 随机生成 ID</h3>
          <label class="pill" style="cursor:pointer;">
            <input type="checkbox" id="wizAutoId" />
            自动生成缺失 ID（8位字母数字）
          </label>
          <p class="hint">
            开启后不会覆盖已有 ID；可在编辑区点击“为本楼生成ID”或在批量模块生成随机ID。（只填空白，除非勾选覆盖）
          </p>

          <p class="hint">
            编辑中更改内容/设定后，右侧导出框不会自动更新：会提示你点击“生成 / 刷新预览”。
          </p>
        </div>

        <div class="wizCol">
          <h3 class="wizTitle">5) 选择帖子中显示哪些部分</h3>
          <div class="chkGrid" id="wizFields"></div>

          <h3 class="wizTitle" style="margin-top:14px;">预览（随勾选实时更新）</h3>
          <div class="wizPreview" id="wizPreview"></div>
        </div>
      </div>

      <div class="wizFoot">
        <button id="btnResetWiz" type="button">恢复默认</button>
        <button class="primary" id="btnApplyWiz" type="button">应用并进入编辑</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- LEFT -->
    <div class="card editorCard">
      <h1>编辑区</h1>

      <div class="optRow">
        <span class="pill">风格：<strong id="uiStyleName"></strong></span>
        <span class="pill">导出：<strong id="uiExportName"></strong></span>
        <span class="pill">时间：<strong id="uiTimeFmt"></strong></span>
        <span class="pill">随机ID：<strong id="uiAutoId"></strong></span>
        <button class="tinyBtn" id="btnOpenWiz" type="button">更改设置</button>
      </div>

      <!-- 左侧顺序 1：帖子标题 -->
      <label>帖子标题</label>
      <input id="inpTitle" placeholder="标题" />

      <!-- 左侧顺序 2：一组按钮（渲染/下载/保存/新帖） -->
      <div class="btns" style="margin-top:10px;">
        <button class="primary" id="btnRender" type="button">生成 / 刷新预览</button>
        <button id="btnDownload" type="button">下载当前内容</button>
        <button id="btnSave" type="button">立即保存（本地）</button>
        <button class="danger" id="btnNew" type="button">开始新帖子（一键清除）</button>
      </div>

      <!-- 左侧顺序 3：自动推理时间（模块） -->
      <div class="module" id="timeModule">
        <div class="moduleHead">
          <strong>自动推理时间</strong>
          <span class="small">按锚点与随机推进生成（可锁定）</span>
        </div>

        <!-- 首楼时间锚点 -->
        <div class="optRow">
          <span class="small">首楼时间：</span>
          <input class="mini" id="inpFirstTime" placeholder="02-09 23:58:10" />
          <button class="tinyBtn" id="btnApplyFirstTime" type="button">写入首楼</button>
          <span class="small">（作为时间锚点；写入会自动解锁旧锁定）</span>
        </div>

        <!-- 随机时间 -->
        <div class="optRow">
          <span class="pill">状态：<strong id="randState">未锁定</strong></span>
          <label class="pill" style="cursor:pointer;">
            <input type="checkbox" id="optRandomTime" checked />
            后续楼层自动推进/填充
          </label>
          <span class="small">随机推进（秒）：</span>
          <input class="mini" type="number" id="optMinSec" min="0" value="5" />
          <span class="small">到</span>
          <input class="mini" type="number" id="optMaxSec" min="0" value="45" />
          <button class="tinyBtn" id="btnLockTimes" type="button">生成并锁定</button>
          <button class="tinyBtn" id="btnRerollTimes" type="button">重新随机</button>
          <button class="tinyBtn" id="btnUnlockTimes" type="button">解锁</button>
        </div>

        <p class="hint" style="margin-top:6px;">
          提示：当你在某一楼手动填入时间时，系统会把“中间空白楼层”随机落在两次时间之间（可跨日期）。
        </p>
      </div>

      <!-- 左侧顺序 4：批量操作（模块） -->
      <div class="module" id="bulkModule">
        <div class="moduleHead">
          <strong>批量操作（基于楼层选择）</strong>
          <span class="small">先在列表左侧勾选楼层</span>
        </div>

        <div class="optRow" style="margin-top:0;">
          <button class="tinyBtn" id="btnSelectAll" type="button">全选</button>
          <button class="tinyBtn" id="btnSelectNone" type="button">全部取消</button>
          <span class="pill">已选：<strong id="selCount">0</strong></span>
        </div>

        <div class="moduleGrid2">
          <!-- 左：昵称 -->
          <div class="subCard">
            <div class="subCardTitle">批量昵称</div>
            <label>输入昵称（可空）</label>
            <input id="bulkName" placeholder="例如：某某" />

            <div class="optRow" style="margin-top:8px;">
              <label class="pill" style="cursor:pointer;">
                <input type="checkbox" id="bulkOverwriteName" />
                覆盖已填昵称
              </label>
            </div>

            <div class="subActions">
              <button class="tinyBtn" id="btnApplySelectedName" type="button">应用到已选楼层</button>
              <button class="tinyBtn" id="btnApplyAllName" type="button">应用全部楼层</button>
            </div>

            <div class="small" style="margin-top:8px;">
              “应用全部楼层”：若未勾选覆盖，则只填充空白昵称；勾选覆盖则覆盖所有楼层昵称。
            </div>
          </div>

          <!-- 右：ID -->
          <div class="subCard">
            <div class="subCardTitle">批量ID</div>
            <label>输入ID（可空）</label>
            <input id="bulkUid" placeholder="例如：a1B2c3D4" />

            <div class="optRow" style="margin-top:8px;">
              <label class="pill" style="cursor:pointer;">
                <input type="checkbox" id="bulkOverwriteUid" />
                覆盖已填ID
              </label>
            </div>

            <div class="subActions">
              <button class="tinyBtn" id="btnApplySelectedUid" type="button">应用到已选楼层</button>
              <button class="tinyBtn" id="btnApplyAllUid" type="button">应用全部楼层</button>
              <button class="tinyBtn" id="btnGenAllIds" type="button">为全部楼层随机ID</button>
            </div>

            <div class="small" style="margin-top:8px;">
              “为全部楼层随机ID”：需在设置中开启自动ID。若未勾选覆盖，则只给空白ID生成；勾选覆盖则全部重生成。
            </div>
          </div>
        </div>

        <div class="small" style="margin-top:10px;color:#666;">
          提示：未选楼层不会被“应用到已选楼层”影响。
        </div>
      </div>

      <!-- 左侧顺序 5：+ 在最末尾加入一层楼 + 批量加入 -->
      <div class="btns">
        <button id="btnAdd" type="button">+ 在最末尾加入一层楼</button>

        <!-- 新增：批量加入楼层 -->
        <div class="optRow" style="margin-top:0;">
          <span class="small">批量加入：</span>
          <input class="miniSm" type="number" id="inpBulkAddCount" min="2" max="100" value="2" />
          <button class="tinyBtn" id="btnBulkAdd" type="button">在最末尾批量加入</button>
          <span class="small">（2-100）</span>
        </div>
      </div>

      <div id="status" class="status"></div>

      <!-- 左侧顺序 6：帖子内容 -->
      <div id="posts"></div>
    </div>

    <!-- RIGHT -->
    <div class="card previewCard">
      <h1>导出/预览</h1>

      <!-- 右侧 tabs：预览/导出/导入（同一行） -->
      <div class="segRow" style="margin-top:6px;">
        <button class="segBtn active" id="segPreview" type="button">预览</button>
        <button class="segBtn" id="segExport" type="button">导出进度</button>
        <button class="segBtn" id="segImport" type="button">导入进度</button>
      </div>

      <!-- ====== PREVIEW VIEW ====== -->
      <div class="rightView active" id="viewPreview">
        <div class="btns" style="margin-top:10px;">
          <button id="btnCopyHtml" type="button">复制HTML</button>
          <button id="btnCopyTxt" type="button">复制TXT</button>
          <button id="btnCopyRich" type="button">复制富文本</button>
        </div>
        <p class="hint" style="margin-top:6px;">
          “复制富文本”会将预览框内容以 HTML + 纯文本写入剪贴板（在支持的应用中粘贴可保留格式）。
        </p>

        <label>预览（只读展示，可选中复制）</label>
        <div class="previewBox" id="preview"></div>

        <label>导出内容（当前导出模式）</label>
        <textarea class="mono" id="outText" readonly></textarea>
        <p class="hint" id="exportHint"></p>
      </div>

      <!-- ====== EXPORT VIEW ====== -->
      <div class="rightView" id="viewExport">
        <div class="btns" style="margin-top:10px;">
          <button class="primary" id="btnExportJsonDownload" type="button">下载进度JSON</button>
        </div>
        <p class="hint">
          进度导出为 JSON 文件（用于跨设备/跨浏览器迁移）。本地存档（localStorage）只在同设备同浏览器同域名下生效。
        </p>
      </div>

      <!-- ====== IMPORT VIEW ====== -->
      <div class="rightView" id="viewImport">
        <div class="btns" style="margin-top:10px;">
          <input id="importJsonFile" type="file" accept=".json,application/json" />
          <button class="primary" id="btnImportApply" type="button">导入JSON并覆盖当前</button>
        </div>
        <p class="hint">
          选择你之前导出的 JSON 文件，然后点击“导入JSON并覆盖当前”。导入后建议点一次“生成 / 刷新预览”确认显示正常。
        </p>
      </div>
    </div>
  </div>

  <!-- 手机底部操作栏 -->
  <div class="appDock" id="appDock" style="display:none;">
    <div class="dockInner">
      <div class="dockTop">
        <div class="dockTabs">
          <button class="dockTab active" id="tabEdit" type="button">编辑</button>
          <button class="dockTab" id="tabPreview" type="button">预览</button>
          <button class="dockTab" id="tabExport" type="button">导出</button>
          <button class="dockTab" id="tabImport" type="button">导入</button>
        </div>
        <div class="dockRight">
          <button class="dockBtn" id="dockWiz" type="button">设置</button>
          <button class="dockBtn primary" id="dockRender" type="button">刷新</button>
        </div>
      </div>

      <!-- Dock Actions：三键复制（同桌面） -->
      <div class="dockActions" id="dockActions">
        <button class="dockBtn" id="dockCopyHtml" type="button">复制HTML</button>
        <button class="dockBtn" id="dockCopyTxt" type="button">复制TXT</button>
        <button class="dockBtn" id="dockCopyRich" type="button">复制富文本</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const STORAGE_KEY = "forum_builder_rte_custom_v8";

  const FIELD_DEFS = [
    { key:"name", label:"昵称（name）" },
    { key:"uid", label:"ID（@uid）" },
    { key:"time", label:"时间（time）" },
    { key:"floor", label:"楼层号（#floor）" },
    { key:"quote", label:"引用块（quote）" },
    { key:"quote_by", label:"引用署名（quote_by）" },
    { key:"body", label:"正文（body）" }
  ];

  const defaultConfig = () => ({
    style: "classic",
    exportMode: "ao3_html",
    fields: { name:true, uid:true, time:true, floor:true, quote:true, quote_by:true, body:true },
    customPostTemplate: "",
    time: { showYear: false, clock: "24h" },  // "24h" | "12h"
    autoId: { enabled: false, length: 8 }
  });

  const emptyPost = () => ({
    name:"", uid:"", time:"",
    hasQuote:false, quoteHtml:"", quoteBy:"",
    bodyHtml:""
  });

  const defaultState = () => ({
    config: defaultConfig(),
    title: "在此处输入帖子标题",
    options: { randomTimeEnabled:true, minSec:5, maxSec:45, locked:false, lockedTimes:[] },
    posts: [
      { ...emptyPost(), bodyHtml:"<p>第一层正文（可加粗/斜体/下划线）。</p>" },
      { ...emptyPost(), hasQuote:true, quoteHtml:"<p><i>这是引用内容</i><br>可以多行。</p>", quoteBy:"——引用署名", bodyHtml:"<p>第二层正文。</p>" }
    ],
    ui: { selected: [] }
  });

  let state = loadState() ?? defaultState();
  let lastActiveIndex = 0;

  // --------- “只提示需要刷新”机制 ---------
  let exportDirty = false;
  function markExportDirty(msg="已更改内容/设定，点击“生成 / 刷新预览”以更新右侧导出框。"){
    exportDirty = true;
    exportHint.textContent = "⚠️ 导出内容可能未更新：请点击“生成 / 刷新预览”。";
    setStatus(msg, "warn");
  }
  function clearExportDirty(msg="已刷新，导出框已更新。"){
    exportDirty = false;
    setStatus(msg, "ok");
  }

  let autosaveTimer = null;
  let activeRte = null;

  // DOM
  const wizardMask = document.getElementById("wizardMask");
  const btnOpenWiz = document.getElementById("btnOpenWiz");
  const btnCloseWiz = document.getElementById("btnCloseWiz");
  const btnApplyWiz = document.getElementById("btnApplyWiz");
  const btnResetWiz = document.getElementById("btnResetWiz");

  const wizStyle = document.getElementById("wizStyle");
  const customTplBox = document.getElementById("customTplBox");
  const wizCustomPostTpl = document.getElementById("wizCustomPostTpl");
  const wizExport = document.getElementById("wizExport");
  const wizFields = document.getElementById("wizFields");
  const wizPreview = document.getElementById("wizPreview");
  const wizShowYear = document.getElementById("wizShowYear");
  const wizClockMode = document.getElementById("wizClockMode");
  const wizAutoId = document.getElementById("wizAutoId");

  const uiStyleName = document.getElementById("uiStyleName");
  const uiExportName = document.getElementById("uiExportName");
  const uiTimeFmt = document.getElementById("uiTimeFmt");
  const uiAutoId = document.getElementById("uiAutoId");
  const exportHint = document.getElementById("exportHint");

  const inpTitle = document.getElementById("inpTitle");
  const postsEl = document.getElementById("posts");
  const previewEl = document.getElementById("preview");
  const outText = document.getElementById("outText");
  const statusEl = document.getElementById("status");

  const inpFirstTime = document.getElementById("inpFirstTime");
  const btnApplyFirstTime = document.getElementById("btnApplyFirstTime");

  const optRandomTime = document.getElementById("optRandomTime");
  const optMinSec = document.getElementById("optMinSec");
  const optMaxSec = document.getElementById("optMaxSec");
  const randState = document.getElementById("randState");
  const btnLockTimes = document.getElementById("btnLockTimes");
  const btnRerollTimes = document.getElementById("btnRerollTimes");
  const btnUnlockTimes = document.getElementById("btnUnlockTimes");

  const btnAdd = document.getElementById("btnAdd");

  // 新增：批量加入楼层
  const inpBulkAddCount = document.getElementById("inpBulkAddCount");
  const btnBulkAdd = document.getElementById("btnBulkAdd");

  const btnRender = document.getElementById("btnRender");
  const btnDownload = document.getElementById("btnDownload");
  const btnSave = document.getElementById("btnSave");
  const btnNew = document.getElementById("btnNew");

  // 批量模块（新两栏）
  const btnSelectAll = document.getElementById("btnSelectAll");
  const btnSelectNone = document.getElementById("btnSelectNone");
  const selCountEl = document.getElementById("selCount");

  const bulkName = document.getElementById("bulkName");
  const bulkUid = document.getElementById("bulkUid");
  const bulkOverwriteName = document.getElementById("bulkOverwriteName");
  const bulkOverwriteUid = document.getElementById("bulkOverwriteUid");

  const btnApplySelectedName = document.getElementById("btnApplySelectedName");
  const btnApplyAllName = document.getElementById("btnApplyAllName");
  const btnApplySelectedUid = document.getElementById("btnApplySelectedUid");
  const btnApplyAllUid = document.getElementById("btnApplyAllUid");
  const btnGenAllIds = document.getElementById("btnGenAllIds");

  // 复制按钮（三键）
  const btnCopyHtml = document.getElementById("btnCopyHtml");
  const btnCopyTxt  = document.getElementById("btnCopyTxt");
  const btnCopyRich = document.getElementById("btnCopyRich");

  // 右侧视图 tabs
  const segPreview = document.getElementById("segPreview");
  const segExport  = document.getElementById("segExport");
  const segImport  = document.getElementById("segImport");
  const viewPreview = document.getElementById("viewPreview");
  const viewExport  = document.getElementById("viewExport");
  const viewImport  = document.getElementById("viewImport");

  // 导入导出（文件）
  const btnExportJsonDownload = document.getElementById("btnExportJsonDownload");
  const importJsonFile = document.getElementById("importJsonFile");
  const btnImportApply = document.getElementById("btnImportApply");

  // utils
  function setStatus(msg, kind="ok"){ statusEl.textContent = msg||""; statusEl.className = "status " + (kind||""); }
  function escapeText(s){ return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
  function escapeAttr(s){ return String(s??"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

  function debounceAutosave(){
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(()=>{ saveState(); }, 350);
  }
  function saveState(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); return true; }
    catch(e){ setStatus("本地保存失败。","warn"); return false; }
  }
  function loadState(){
    try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return null; return normalizeState(JSON.parse(raw)); }
    catch(e){ return null; }
  }
  function normalizeState(s){
    const base = defaultState();
    if(!s || typeof s !== "object") return base;

    s.config = s.config || base.config;
    s.config.style = s.config.style || base.config.style;
    s.config.exportMode = s.config.exportMode || base.config.exportMode;
    s.config.fields = Object.assign({}, base.config.fields, s.config.fields || {});
    s.config.customPostTemplate = (typeof s.config.customPostTemplate === "string") ? s.config.customPostTemplate : base.config.customPostTemplate;
    s.config.time = Object.assign({}, base.config.time, s.config.time || {});
    if(!["24h","12h"].includes(s.config.time.clock)) s.config.time.clock = "24h";
    s.config.time.showYear = !!s.config.time.showYear;

    s.config.autoId = Object.assign({}, base.config.autoId, s.config.autoId || {});
    s.config.autoId.enabled = !!s.config.autoId.enabled;
    s.config.autoId.length = 8;

    s.title = (typeof s.title === "string") ? s.title : base.title;

    s.options = Object.assign({}, base.options, s.options || {});
    if(!Array.isArray(s.options.lockedTimes)) s.options.lockedTimes = [];

    if(!Array.isArray(s.posts)) s.posts = base.posts;
    s.posts = s.posts.map(p=>{
      const bp = emptyPost();
      p = Object.assign(bp, p || {});
      p.hasQuote = !!p.hasQuote;
      p.quoteHtml = String(p.quoteHtml||"");
      p.bodyHtml = String(p.bodyHtml||"");
      p.quoteBy = String(p.quoteBy||"");
      p.name = String(p.name||"");
      p.uid = String(p.uid||"");
      p.time = String(p.time||"");
      return p;
    });

    s.ui = s.ui || base.ui;
    if(!Array.isArray(s.ui.selected)) s.ui.selected = [];
    if(s.ui.selected.length !== s.posts.length){
      const next = new Array(s.posts.length).fill(false);
      for(let i=0;i<Math.min(s.ui.selected.length, next.length);i++) next[i] = !!s.ui.selected[i];
      s.ui.selected = next;
    } else {
      s.ui.selected = s.ui.selected.map(v=>!!v);
    }
    return s;
  }

  // helpers
  function clampNum(v,min,max){ if(!Number.isFinite(v)) return min; return Math.max(min, Math.min(max,v)); }
  function randInt(min,max){ const a = Math.min(min,max), b = Math.max(min,max); return Math.floor(Math.random()*(b-a+1))+a; }
  function genRandomId(len=8){
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    let out = "";
    for(let i=0;i<len;i++) out += chars.charAt(Math.floor(Math.random()*chars.length));
    return out;
  }

  // selection
  function selectedIndexes(){
    const sel = state.ui.selected || [];
    const out = [];
    for(let i=0;i<sel.length;i++) if(sel[i]) out.push(i);
    return out;
  }
  function selectedCount(){ return selectedIndexes().length; }
  function syncSelBadge(){ if(selCountEl) selCountEl.textContent = String(selectedCount()); }

  function ensureSelLength(){
    if(!state.ui) state.ui = { selected: [] };
    if(!Array.isArray(state.ui.selected)) state.ui.selected = [];
    if(state.ui.selected.length !== state.posts.length){
      const next = new Array(state.posts.length).fill(false);
      for(let i=0;i<Math.min(state.ui.selected.length, next.length);i++) next[i] = !!state.ui.selected[i];
      state.ui.selected = next;
    }
  }
  function selectAll(){
    state.ui.selected = new Array(state.posts.length).fill(true);
    debounceAutosave();
    renderPosts();
    syncSelBadge();
    setStatus("已全选。","ok");
  }
  function selectNone(){
    state.ui.selected = new Array(state.posts.length).fill(false);
    debounceAutosave();
    renderPosts();
    syncSelBadge();
    setStatus("已全部取消选择。","ok");
  }

  // --------- TIME ---------
  function normalizeTimeOptions(){
    state.options.randomTimeEnabled = !!optRandomTime.checked;
    state.options.minSec = clampNum(+optMinSec.value,0,86400*365);
    state.options.maxSec = clampNum(+optMaxSec.value,0,86400*365);
    optMinSec.value = state.options.minSec;
    optMaxSec.value = state.options.maxSec;
  }

  function getTimePlaceholder(){
    return (state.config.time.clock === "12h")
      ? (state.config.time.showYear ? "2026-02-09 11:58 PM" : "02-09 11:58 PM")
      : (state.config.time.showYear ? "2026-02-09 23:58:10" : "02-09 23:58:10");
  }

  function parseTime(str){
    const s = String(str||"").trim();
    if(!s) return null;

    const r12 = /^(\d{4})-(\d{2})-(\d{2})\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)$/i;
    const r12NoY = /^(\d{2})-(\d{2})\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)$/i;
    const r24 = /^(\d{4})-(\d{2})-(\d{2})\s+(\d{1,2}):(\d{2})(?::(\d{2}))?$/;
    const r24NoY = /^(\d{2})-(\d{2})\s+(\d{1,2}):(\d{2})(?::(\d{2}))?$/;

    let m;
    const clock = state.config.time.clock;

    if(clock === "12h"){
      m = s.match(r12);
      if(m){
        const Y=+m[1], Mo=+m[2], D=+m[3], hh=+m[4], mi=+m[5], ss=+(m[6]||0), ap=m[7].toUpperCase();
        if(hh<1||hh>12||mi>59||ss>59) return null;
        let H = hh % 12; if(ap==="PM") H += 12;
        return new Date(Y, Mo-1, D, H, mi, ss, 0);
      }
      m = s.match(r12NoY);
      if(m){
        const Y = 2026;
        const Mo=+m[1], D=+m[2], hh=+m[3], mi=+m[4], ss=+(m[5]||0), ap=m[6].toUpperCase();
        if(hh<1||hh>12||mi>59||ss>59) return null;
        let H = hh % 12; if(ap==="PM") H += 12;
        return new Date(Y, Mo-1, D, H, mi, ss, 0);
      }
      return null;
    }

    m = s.match(r24);
    if(m){
      const Y=+m[1], Mo=+m[2], D=+m[3], H=+m[4], mi=+m[5], ss=+(m[6]||0);
      if(H>23||mi>59||ss>59) return null;
      return new Date(Y, Mo-1, D, H, mi, ss, 0);
    }
    m = s.match(r24NoY);
    if(m){
      const Y = 2026;
      const Mo=+m[1], D=+m[2], H=+m[3], mi=+m[4], ss=+(m[5]||0);
      if(H>23||mi>59||ss>59) return null;
      return new Date(Y, Mo-1, D, H, mi, ss, 0);
    }
    return null;
  }

  function fmtTime(d){
    const showYear = !!state.config.time.showYear;
    const clock = state.config.time.clock;
    const Y = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    const ss = String(d.getSeconds()).padStart(2,"0");

    if(clock === "12h"){
      let H = d.getHours();
      const ap = (H >= 12) ? "PM" : "AM";
      H = H % 12; if(H===0) H = 12;
      const hh = String(H).padStart(2,"0");
      const datePart = showYear ? `${Y}-${mm}-${dd}` : `${mm}-${dd}`;
      return `${datePart} ${hh}:${mi}:${ss} ${ap}`;
    } else {
      const hh = String(d.getHours()).padStart(2,"0");
      const datePart = showYear ? `${Y}-${mm}-${dd}` : `${mm}-${dd}`;
      return `${datePart} ${hh}:${mi}:${ss}`;
    }
  }

  function computeDisplayTimes(){
    const n = state.posts.length;
    const times = new Array(n).fill("");
    normalizeTimeOptions();

    const manual = state.posts.map(p=>String(p.time||"").trim());
    const locked = Array.isArray(state.options.lockedTimes) ? state.options.lockedTimes : [];

    for(let i=0;i<n;i++){
      if(manual[i]) times[i]=manual[i];
      else if(state.options.locked && locked[i]) times[i]=locked[i];
    }
    if(!state.options.randomTimeEnabled) return times;

    const anchors = [];
    for(let i=0;i<n;i++){
      if(times[i]){
        const d = parseTime(times[i]);
        if(d) anchors.push({i, d});
      }
    }
    if(anchors.length === 0) return times;

    // fill between anchors
    for(let ai=0; ai<anchors.length-1; ai++){
      const A = anchors[ai], B = anchors[ai+1];
      if(B.i <= A.i+1) continue;
      const startT = A.d.getTime(), endT = B.d.getTime();
      if(endT <= startT) continue;

      const blanks = [];
      for(let j=A.i+1; j<B.i; j++) if(!times[j]) blanks.push(j);
      if(!blanks.length) continue;

      const picks = [];
      const gap = endT - startT;
      const safety = 1;
      for(let k=0;k<blanks.length;k++){
        picks.push(startT + safety + Math.floor(Math.random()*(gap - 2*safety)));
      }
      picks.sort((x,y)=>x-y);
      for(let k=0;k<picks.length;k++){
        if(k>0 && picks[k] <= picks[k-1]) picks[k] = picks[k-1] + 1;
      }
      for(let k=picks.length-1;k>=0;k--){
        if(picks[k] >= endT) picks[k] = endT - (picks.length-k);
      }
      blanks.forEach((idx,k)=> times[idx] = fmtTime(new Date(picks[k])));
    }

    // after last anchor: progressive random step
    const lastA = anchors[anchors.length-1];
    let cursor = lastA.d;
    for(let i=lastA.i+1; i<n; i++){
      if(times[i]){
        const d = parseTime(times[i]);
        if(d) cursor = d;
        continue;
      }
      const step = randInt(state.options.minSec, state.options.maxSec);
      cursor = new Date(cursor.getTime() + step*1000);
      times[i] = fmtTime(cursor);
    }
    return times;
  }

  function updateRandBadge(){ randState.textContent = state.options.locked ? "已锁定" : "未锁定"; }

  function lockTimes(){
    const display = computeDisplayTimes();
    state.options.locked = true;
    state.options.lockedTimes = state.posts.map((p,i)=> (String(p.time||"").trim() ? "" : (display[i]||"")));
    updateRandBadge();
    debounceAutosave();
    refreshAll();
  }
  function rerollTimes(){
    state.options.locked = false;
    state.options.lockedTimes = new Array(state.posts.length).fill("");
    lockTimes();
    setStatus("已重新随机并锁定。","ok");
  }
  function unlockTimes(silent=false){
    state.options.locked = false;
    state.options.lockedTimes = [];
    updateRandBadge();
    debounceAutosave();
    if(!silent) markExportDirty("已解锁时间（导出未刷新）。点击“生成 / 刷新预览”更新。");
  }

  // RTE toolbar
  function rteCommand(cmd, val=null){
    if(!activeRte) return;
    activeRte.focus();
    try{ document.execCommand(cmd, false, val); }catch(e){}
  }
  function rteLink(){
    if(!activeRte) return;
    const url = prompt("输入链接 URL：");
    if(!url) return;
    rteCommand("createLink", url);
  }
  function rteClear(){ rteCommand("removeFormat"); }

  // structure styles (HTML)
  function renderPostByStyle(style, ctx){
    const show = ctx.show;
    const namePart = show.name ? `<strong>${escapeText(ctx.name)}</strong>` : "";
    const uidPart  = show.uid ? `@${escapeText(ctx.uid)}` : "";
    const timePart = (show.time && ctx.time) ? escapeText(ctx.time) : "";
    const floorPart= show.floor ? `#${ctx.floor}` : "";

    const quoteBlock = (show.quote && ctx.quoteHtml && ctx.quoteHtml.trim())
      ? `<div class="quote">${ctx.quoteHtml}${(show.quote_by && ctx.quoteBy && ctx.quoteBy.trim()) ? `<div class="quote-by">${escapeText(ctx.quoteBy)}</div>` : ""}</div>`
      : "";

    const bodyBlock = (show.body && ctx.bodyHtml && ctx.bodyHtml.trim()) ? `<div class="body">${ctx.bodyHtml}</div>` : "";

    if(style==="classic"){
      const left = [namePart, uidPart].filter(Boolean).join(" ");
      const right = [timePart, floorPart].filter(Boolean).join(" ");
      const head = [left, right].filter(Boolean).join(" ｜ ");
      return `<div class="post">
  ${head ? `<p class="user">${head}</p>` : ""}
  <div class="content">
    ${quoteBlock}
    ${bodyBlock}
  </div>
</div>`;
    }
    if(style==="splitmeta"){
      const left = [namePart, uidPart].filter(Boolean).join(" ");
      const right = [timePart, floorPart].filter(Boolean).join(" · ");
      return `<div class="post">
  ${(left || right) ? `<p class="user">${left}${(left && right) ? "　　" : ""}${right}</p>` : ""}
  <div class="content">
    ${quoteBlock}
    ${bodyBlock}
  </div>
</div>`;
    }
    if(style==="compact"){
      const head = [floorPart, namePart, uidPart, timePart].filter(Boolean).join(" · ");
      return `<div class="post">
  ${head ? `<p class="user">${head}</p>` : ""}
  <div class="content">
    ${quoteBlock}
    ${bodyBlock}
  </div>
</div>`;
    }
    if(style==="bubble"){
      const headA = [namePart, uidPart].filter(Boolean).join(" ");
      const headB = [timePart, floorPart].filter(Boolean).join(" ");
      return `<div class="post">
  ${(headA || headB) ? `<p class="user">${headA}${(headA && headB) ? " ｜ " : ""}${headB}</p>` : ""}
  ${quoteBlock ? `<div class="block-quote">${quoteBlock}</div>` : ""}
  ${bodyBlock ? `<div class="block-body">${bodyBlock}</div>` : ""}
</div>`;
    }
    return renderPostByStyle("classic", ctx);
  }

  function renderPostByCustomTemplate(ctx){
    const show = ctx.show;
    const tpl = (state.config.customPostTemplate || "").trim();
    if(!tpl) return renderPostByStyle("classic", ctx);

    const rep = (val, enabled) => enabled ? val : "";
    const name = rep(`<strong>${escapeText(ctx.name)}</strong>`, show.name);
    const uid  = rep(`@${escapeText(ctx.uid)}`, show.uid);
    const time = rep(escapeText(ctx.time || ""), show.time);
    const floor= rep(String(ctx.floor), show.floor);

    const quote = rep((ctx.quoteHtml || ""), show.quote);
    const quoteBy = rep(escapeText(ctx.quoteBy || ""), show.quote_by);
    const body  = rep((ctx.bodyHtml || ""), show.body);

    return tpl
      .replaceAll("{{name}}", name)
      .replaceAll("{{uid}}", uid)
      .replaceAll("{{time}}", time)
      .replaceAll("{{floor}}", floor)
      .replaceAll("{{quote}}", quote)
      .replaceAll("{{quote_by}}", quoteBy)
      .replaceAll("{{body}}", body);
  }

  function buildExportHtml(){
    const show = state.config.fields;
    const times = computeDisplayTimes();
    const title = escapeText(state.title || "");
    const style = state.config.style;

    const inner = state.posts.map((p, idx)=>{
      const useQuote = !!p.hasQuote;
      const ctx = {
        show,
        name: p.name || "",
        uid: p.uid || "",
        time: times[idx] || "",
        floor: idx+1,
        quoteHtml: useQuote ? (p.quoteHtml || "") : "",
        quoteBy: useQuote ? (p.quoteBy || "") : "",
        bodyHtml: p.bodyHtml || ""
      };
      if(style === "custom") return renderPostByCustomTemplate(ctx);
      return renderPostByStyle(style, ctx);
    }).join("\n");

    return `<div class="forum">
  <h3 class="title">${title}</h3>
  ${inner}
</div>`;
  }

  // html->text
  function htmlToText(html){
    const div = document.createElement("div");
    div.innerHTML = html || "";
    return div.innerText.replace(/\n{3,}/g,"\n\n").trim();
  }

  // TXT style renderer
  function renderPostTxtByStyle(style, ctx){
    const show = ctx.show;
    const name = show.name ? (ctx.name || "") : "";
    const uid  = show.uid  ? ("@" + (ctx.uid || "")) : "";
    const time = (show.time && ctx.time) ? (ctx.time || "") : "";
    const floor= show.floor ? ("#" + ctx.floor) : "";

    const headClassicLeft = [name, uid].filter(Boolean).join(" ");
    const headClassicRight= [time, floor].filter(Boolean).join(" ｜ ");
    const headClassic = [headClassicLeft, headClassicRight].filter(Boolean).join(" ｜ ");

    const headSplit = (() => {
      const left = [name, uid].filter(Boolean).join(" ");
      const right= [time, floor].filter(Boolean).join(" · ");
      return [left, right].filter(Boolean).join("    ");
    })();
    const headCompact = [floor, name, uid, time].filter(Boolean).join(" · ");

    const quoteText = (show.quote && (ctx.quoteHtml||"").trim()) ? htmlToText(ctx.quoteHtml) : "";
    const quoteByText = (show.quote_by && (ctx.quoteBy||"").trim()) ? (ctx.quoteBy||"").trim() : "";
    const bodyText  = (show.body && (ctx.bodyHtml||"").trim()) ? htmlToText(ctx.bodyHtml) : "";

    if(style === "splitmeta"){
      return [headSplit, quoteText ? "【引用】\n"+quoteText+(quoteByText?("\n"+quoteByText):"") : "", bodyText].filter(Boolean).join("\n");
    }
    if(style === "compact"){
      return [headCompact, quoteText ? "【引】"+quoteText+(quoteByText?("\n"+quoteByText):"") : "", bodyText].filter(Boolean).join("\n");
    }
    if(style === "bubble"){
      return [headClassic, quoteText ? "【引用块】\n"+quoteText+(quoteByText?("\n"+quoteByText):"") : "", bodyText ? "【正文】\n"+bodyText : ""].filter(Boolean).join("\n");
    }
    return [headClassic, quoteText ? "【引用】\n"+quoteText+(quoteByText?("\n"+quoteByText):"") : "", bodyText].filter(Boolean).join("\n");
  }

  function renderPostTxtByCustomTemplate(ctx){
    const tpl = (state.config.customPostTemplate || "").trim();
    if(!tpl) return renderPostTxtByStyle("classic", ctx);

    const show = ctx.show;
    const rep = (val, enabled) => enabled ? val : "";

    const name = rep(ctx.name || "", show.name);
    const uid  = rep("@" + (ctx.uid || ""), show.uid);
    const time = rep(ctx.time || "", show.time);
    const floor= rep(String(ctx.floor), show.floor);

    const quote = rep(htmlToText(ctx.quoteHtml || ""), show.quote);
    const quoteBy = rep((ctx.quoteBy || "").trim(), show.quote_by);
    const body  = rep(htmlToText(ctx.bodyHtml || ""), show.body);

    return tpl
      .replaceAll("{{name}}", name)
      .replaceAll("{{uid}}", uid)
      .replaceAll("{{time}}", time)
      .replaceAll("{{floor}}", floor)
      .replaceAll("{{quote}}", quote)
      .replaceAll("{{quote_by}}", quoteBy)
      .replaceAll("{{body}}", body);
  }

  function buildExportTxt(){
    const show = state.config.fields;
    const times = computeDisplayTimes();
    const lines = [];
    lines.push(state.title || "");
    lines.push("");

    const style = state.config.style;

    state.posts.forEach((p, idx)=>{
      const useQuote = !!p.hasQuote;
      const ctx = {
        show,
        name: p.name || "",
        uid: p.uid || "",
        time: times[idx] || p.time || "",
        floor: idx + 1,
        quoteHtml: useQuote ? (p.quoteHtml || "") : "",
        quoteBy: useQuote ? (p.quoteBy || "") : "",
        bodyHtml: p.bodyHtml || ""
      };
      const block = (style === "custom") ? renderPostTxtByCustomTemplate(ctx) : renderPostTxtByStyle(style, ctx);
      if(block.trim()) lines.push(block.trim());
      lines.push("\n---\n");
    });

    return lines.join("\n").replace(/\n{3,}/g,"\n\n");
  }

  function updateTopBadges(){
    const styleNameMap = {classic:"Classic",splitmeta:"SplitMeta",compact:"Compact",bubble:"Bubble",custom:"Custom"};
    uiStyleName.textContent = styleNameMap[state.config.style] || "Classic";
    uiExportName.textContent = state.config.exportMode === "ao3_html" ? "AO3 HTML" : "TXT";
    uiTimeFmt.textContent = `${state.config.time.clock}${state.config.time.showYear ? " + 年份" : ""}`;
    uiAutoId.textContent = state.config.autoId.enabled ? "开" : "关";
    inpFirstTime.placeholder = getTimePlaceholder();
    btnGenAllIds.disabled = !state.config.autoId.enabled;
  }

  // Wizard fields UI
  function renderWizFields(){
    wizFields.innerHTML = "";
    FIELD_DEFS.forEach(f=>{
      const id = "fld_" + f.key;
      const div = document.createElement("div");
      div.innerHTML = `
        <label class="pill" style="cursor:pointer;display:flex;gap:8px;justify-content:flex-start;">
          <input type="checkbox" id="${id}" ${state.config.fields[f.key] ? "checked":""}/>
          ${f.label}
        </label>`;
      wizFields.appendChild(div);
    });
  }

  function getWizTempConfig(){
    const temp = {
      style: wizStyle.value,
      exportMode: wizExport.value,
      fields: {},
      customPostTemplate: (wizCustomPostTpl ? (wizCustomPostTpl.value || "") : ""),
      time: { showYear: !!wizShowYear.checked, clock: wizClockMode.value },
      autoId: { enabled: !!wizAutoId.checked, length: 8 }
    };
    FIELD_DEFS.forEach(f=>{
      const el = document.getElementById("fld_"+f.key);
      temp.fields[f.key] = !!(el && el.checked);
    });
    return temp;
  }

  function buildWizPreview(){
    const samplePosts = [
      { ...emptyPost(), name:"AAA", uid:"a1B2c3D4", time:"02-09 11:11:05", hasQuote:true, quoteHtml:"<p><i>引用两行</i><br>第二行</p>", quoteBy:"——署名", bodyHtml:"<p>正文第一段</p><p><b>正文第二段</b></p>" },
      { ...emptyPost(), name:"BBB", uid:"Z9y8X7w6", time:"02-09 11:11:25", hasQuote:false, bodyHtml:"<p>回复内容</p>" }
    ];

    const temp = getWizTempConfig();
    const old = JSON.parse(JSON.stringify(state.config));

    state.config.style = temp.style;
    state.config.exportMode = temp.exportMode;
    state.config.fields = temp.fields;
    state.config.customPostTemplate = temp.customPostTemplate;
    state.config.time = temp.time;
    state.config.autoId = temp.autoId;

    customTplBox.style.display = (wizStyle.value === "custom") ? "block" : "none";

    const title = escapeText("示例标题");
    const inner = samplePosts.map((p, idx)=>{
      const ctx = {
        show: state.config.fields,
        name: p.name, uid: p.uid, time: p.time, floor: idx+1,
        quoteHtml: p.hasQuote ? p.quoteHtml : "",
        quoteBy: p.hasQuote ? p.quoteBy : "",
        bodyHtml: p.bodyHtml
      };
      if(state.config.style === "custom") return renderPostByCustomTemplate(ctx);
      return renderPostByStyle(state.config.style, ctx);
    }).join("\n");
    wizPreview.innerHTML = `<div class="forum"><h3 class="title">${title}</h3>${inner}</div>`;

    state.config = old;
  }

  function openWizard(){
    wizStyle.value = state.config.style;
    wizExport.value = state.config.exportMode;
    renderWizFields();
    wizCustomPostTpl.value = state.config.customPostTemplate || "";
    wizShowYear.checked = !!state.config.time.showYear;
    wizClockMode.value = state.config.time.clock || "24h";
    wizAutoId.checked = !!state.config.autoId.enabled;

    customTplBox.style.display = (wizStyle.value === "custom") ? "block" : "none";
    buildWizPreview();
    wizardMask.style.display = "block";
    wizardMask.scrollTop = 0;
  }
  function closeWizard(){ wizardMask.style.display = "none"; }

  // snippets
  function snippetForPost(p){
    const a = (p.hasQuote ? htmlToText(p.quoteHtml||"") : "").replace(/\s+/g," ").slice(0,40);
    const b = htmlToText(p.bodyHtml||"").replace(/\s+/g," ").slice(0,70);
    const parts = [];
    if(a) parts.push("【引】"+a);
    if(b) parts.push(b);
    return parts.join(" / ") || "（暂无内容）";
  }

  function renderPosts(){
    ensureSelLength();
    postsEl.innerHTML = "";
    const times = computeDisplayTimes();
    const show = state.config.fields;
    const timePlaceholder = getTimePlaceholder();

    state.posts.forEach((p,i)=>{
      const d = document.createElement("details");
      d.className="postItem";
      d.dataset.post = String(i);
      d.open = (i === lastActiveIndex);

      const metaBits = [];
      if(show.name) metaBits.push(p.name||"");
      if(show.uid) metaBits.push(p.uid ? ("@"+p.uid) : "");
      if(show.time) metaBits.push(times[i] || p.time || "");
      if(show.floor) metaBits.push("#"+(i+1));
      const meta = metaBits.filter(Boolean).join(" ｜ ") || "（未显示任何头部信息）";

      const timeRaw = String(p.time||"").trim();
      const timeInvalid = !!timeRaw && !parseTime(timeRaw);

      d.innerHTML = `
        <summary class="postSum" data-sum="${i}">
          <div class="sumLeft">
            <input class="sumPick" type="checkbox" data-sel="${i}" ${state.ui.selected[i] ? "checked":""} aria-label="选择楼层"/>
            <div class="sumText">
              <div class="sumMeta">${escapeText(meta)}</div>
              <div class="sumSnippet">${escapeText(snippetForPost(p))}</div>
            </div>
          </div>
          <div class="sumBtns">
            <button class="tinyBtn danger" type="button" data-del="${i}">删除</button>
          </div>
        </summary>

        <div class="editArea">

          ${ (show.name || show.uid) ? `
          <div class="row">
            ${ show.name ? `
            <div>
              <label>昵称（可留空）</label>
              <input data-k="name" data-i="${i}" value="${escapeAttr(p.name)}" placeholder="" />
            </div>` : `<div></div>` }

            ${ show.uid ? `
            <div>
              <label>ID（@后面，可留空）</label>
              <input data-k="uid" data-i="${i}" value="${escapeAttr(p.uid)}" placeholder="" />
              <div class="optRow" style="margin-top:8px;">
                <button class="tinyBtn" type="button" data-genid="${i}">为本楼生成ID</button>
                <span class="small">（8位字母数字；不会覆盖已有ID）</span>
              </div>
            </div>` : `<div></div>` }
          </div>` : "" }

          ${ show.time ? `
          <label>时间（可空=自动生成；支持 ${state.config.time.clock}，${state.config.time.showYear ? "可带年份" : "不强制年份"}）</label>
          <input class="${timeInvalid ? "invalidInput":""}" data-k="time" data-i="${i}" value="${escapeAttr(p.time)}" placeholder="${escapeAttr(timePlaceholder)}" />
          <div class="small dangerText" data-timehint="${i}" style="${timeInvalid ? "" : "display:none;"}">
            时间格式不合法。${state.config.time.clock==="12h" ? "12小时制必须带 AM/PM。" : ""}
          </div>
          <div class="small">提示：后续某楼再次手动输入时间时，中间楼层会随机落在两次时间之间（可跨日期）。</div>
          ` : "" }

          ${ show.quote ? `
          <label class="pill" style="cursor:pointer; display:inline-flex; margin-top:10px;">
            <input type="checkbox" data-k="hasQuote" data-i="${i}" ${p.hasQuote ? "checked":""} />
            本楼需要引用
          </label>
          ` : "" }

          ${ (show.quote && p.hasQuote) ? `
          <label>引用（富文本，可空）</label>
          <div class="rteBar">
            <button type="button" data-rtecmd="bold">B</button>
            <button type="button" data-rtecmd="italic">I</button>
            <button type="button" data-rtecmd="underline">U</button>
            <button type="button" data-rtelink="1">链接</button>
            <button type="button" data-rteclear="1">清除格式</button>
            <button type="button" data-rtecmd="insertLineBreak">换行</button>
          </div>
          <div class="rte" contenteditable="true" data-rte="quote" data-i="${i}" data-placeholder="在这里输入引用内容（可加粗/斜体/下划线）"></div>
          ` : "" }

          ${ (show.quote && show.quote_by && p.hasQuote) ? `
          <label>引用署名（纯文本）</label>
          <input data-k="quoteBy" data-i="${i}" value="${escapeAttr(p.quoteBy)}" placeholder="——署名/出处" />
          ` : "" }

          ${ show.body ? `
          <label>正文（富文本）</label>
          <div class="rteBar">
            <button type="button" data-rtecmd="bold">B</button>
            <button type="button" data-rtecmd="italic">I</button>
            <button type="button" data-rtecmd="underline">U</button>
            <button type="button" data-rtelink="1">链接</button>
            <button type="button" data-rteclear="1">清除格式</button>
            <button type="button" data-rtecmd="insertLineBreak">换行</button>
          </div>
          <div class="rte" contenteditable="true" data-rte="body" data-i="${i}" data-placeholder="在这里输入正文（可加粗/斜体/下划线）"></div>
          ` : "" }

          <div class="optRow" style="margin-top:10px;">
            <button class="tinyBtn" type="button" data-insertbelow="${i}">此楼下方增加一层</button>
            <span class="small">（会在本楼后面插入，并自动展开）</span>
          </div>

          <div class="small">提示：编辑中更改后右侧导出不会自动更新；点“生成 / 刷新预览”刷新导出框。</div>
        </div>
      `;

      postsEl.appendChild(d);

      const q = d.querySelector(`.rte[data-rte="quote"][data-i="\${i}"]`);
      if(q) q.innerHTML = p.quoteHtml || "";
      const b = d.querySelector(`.rte[data-rte="body"][data-i="\${i}"]`);
      if(b) b.innerHTML = p.bodyHtml || "";
    });

    syncSelBadge();
  }

  function refreshAll(){
    updateTopBadges();
    updateRandBadge();
    renderPosts();

    previewEl.innerHTML = buildExportHtml();

    if(state.config.exportMode === "ao3_html"){
      outText.value = buildExportHtml();
      exportHint.textContent = "复制后粘贴到 AO3 的 HTML 编辑器（导出只含结构与内容，不含CSS）。";
    } else {
      outText.value = buildExportTxt();
      exportHint.textContent = "这是 TXT 导出（富文本会转换为纯文本）。";
    }

    debounceAutosave();
    clearExportDirty();
  }

  // --------- Bulk actions ---------
  function requireSelected(){
    const idxs = selectedIndexes();
    if(!idxs.length){
      setStatus("请先在楼层列表左侧勾选要操作的楼层。","warn");
      return null;
    }
    return idxs;
  }

  function applyNameToIndexes(idxs, name, overwrite){
    const nm = String(name||"").trim();
    if(!nm){ setStatus("请先输入要应用的昵称。","warn"); return 0; }
    let changed = 0;
    idxs.forEach(i=>{
      const p = state.posts[i];
      if(!p) return;
      const blank = !String(p.name||"").trim();
      if(overwrite || blank){
        if(p.name !== nm){ p.name = nm; changed++; }
      }
    });
    return changed;
  }

  function applyUidToIndexes(idxs, uid, overwrite){
    const id = String(uid||"").trim();
    if(!id){ setStatus("请先输入要应用的ID。","warn"); return 0; }
    let changed = 0;
    idxs.forEach(i=>{
      const p = state.posts[i];
      if(!p) return;
      const blank = !String(p.uid||"").trim();
      if(overwrite || blank){
        if(p.uid !== id){ p.uid = id; changed++; }
      }
    });
    return changed;
  }

  function genIdsForIndexes(idxs, overwrite){
    if(!state.config.autoId.enabled){
      setStatus("请先在“更改设置”中开启：自动生成缺失 ID。","warn");
      return 0;
    }
    let changed = 0;
    idxs.forEach(i=>{
      const p = state.posts[i];
      if(!p) return;
      const blank = !String(p.uid||"").trim();
      if(overwrite || blank){
        p.uid = genRandomId(state.config.autoId.length || 8);
        changed++;
      }
    });
    return changed;
  }

  function genIdForPost(i){
    if(!state.config.autoId.enabled){
      setStatus("请先在“更改设置”中开启：自动生成缺失 ID。","warn");
      return;
    }
    const p = state.posts[i];
    if(!p) return;
    if(String(p.uid||"").trim()){
      setStatus("该楼已有ID，不会覆盖。","ok");
      return;
    }
    p.uid = genRandomId(state.config.autoId.length || 8);
    debounceAutosave();
    renderPosts();
    updateTopBadges();
    markExportDirty("已为本楼生成ID，点击“生成 / 刷新预览”更新导出。");
  }

  // 插入楼层：在 idx 下方插入
  function insertPostBelow(idx){
    const insertAt = Math.max(0, Math.min(state.posts.length, idx+1));
    state.posts.splice(insertAt, 0, { ...emptyPost(), bodyHtml:"<p>新楼层正文</p>" });

    if(state.options.locked && Array.isArray(state.options.lockedTimes)){
      state.options.lockedTimes.splice(insertAt, 0, "");
    }

    ensureSelLength();
    state.ui.selected.splice(insertAt, 0, false);

    lastActiveIndex = insertAt;
    debounceAutosave();
    refreshAll();

    const el = postsEl.querySelector(`details.postItem[data-post="\${insertAt}"]`);
    if(el){
      el.open = true;
      el.scrollIntoView({behavior:"smooth", block:"start"});
    }
  }

  // 末尾追加楼层（单个）
  function appendPost(){
    const insertAt = state.posts.length;
    state.posts.splice(insertAt, 0, { ...emptyPost(), bodyHtml:"<p>新楼层正文</p>" });

    if(state.options.locked && Array.isArray(state.options.lockedTimes)){
      state.options.lockedTimes.splice(insertAt, 0, "");
    }

    ensureSelLength();
    state.ui.selected.splice(insertAt, 0, false);

    lastActiveIndex = insertAt;
    debounceAutosave();
    refreshAll();

    const el = postsEl.querySelector(`details.postItem[data-post="\${insertAt}"]`);
    if(el){
      el.open = true;
      el.scrollIntoView({behavior:"smooth", block:"start"});
    }
  }

  // 新增：末尾批量追加楼层（2-100）
  function bulkAppendPosts(count){
    const n = clampNum(Math.floor(+count), 2, 100);
    const start = state.posts.length;

    for(let k=0;k<n;k++){
      state.posts.push({ ...emptyPost(), bodyHtml:"<p>新楼层正文</p>" });
      if(state.options.locked && Array.isArray(state.options.lockedTimes)){
        state.options.lockedTimes.push("");
      }
      ensureSelLength();
      state.ui.selected.push(false);
    }

    lastActiveIndex = start; // 批量加入后展开第一层新楼
    debounceAutosave();
    refreshAll();

    const el = postsEl.querySelector(`details.postItem[data-post="\${start}"]`);
    if(el){
      el.open = true;
      el.scrollIntoView({behavior:"smooth", block:"start"});
    }

    markExportDirty(`已在最末尾批量加入 ${n} 层楼，点击“生成 / 刷新预览”更新导出。`);
  }

  // --------- 时间输入即时验证 ---------
  function applyTimeValidity(i, raw){
    const input = postsEl.querySelector(`input[data-k="time"][data-i="\${i}"]`);
    const hint  = postsEl.querySelector(`[data-timehint="\${i}"]`);
    const v = String(raw||"").trim();
    const invalid = !!v && !parseTime(v);
    if(input) input.classList.toggle("invalidInput", invalid);
    if(hint){
      hint.style.display = invalid ? "" : "none";
      if(invalid) hint.textContent = "时间格式不合法。" + (state.config.time.clock==="12h" ? "12小时制必须带 AM/PM。" : "");
    }
  }

  // ---------- Clipboard ----------
  async function copyToClipboardText(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      ta.style.top = "0";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      try{
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return ok;
      }catch(err){
        document.body.removeChild(ta);
        return false;
      }
    }
  }

  async function copyHtmlSnippet(){
    const html = buildExportHtml();
    const ok = await copyToClipboardText(html);
    setStatus(ok ? "已复制 HTML。" : "复制失败，请手动选中复制。", ok ? "ok" : "warn");
  }

  async function copyTxtAll(){
    const txt = buildExportTxt();
    const ok = await copyToClipboardText(txt);
    setStatus(ok ? "已复制 TXT。" : "复制失败，请手动选中复制。", ok ? "ok" : "warn");
  }

  async function copyRichFromPreview(){
    const html = (previewEl && previewEl.innerHTML) ? previewEl.innerHTML : "";
    const text = (previewEl && previewEl.innerText) ? previewEl.innerText : "";
    if(!html && !text){
      setStatus("预览为空，无法复制。","warn");
      return;
    }

    try{
      if(navigator.clipboard && window.ClipboardItem){
        const item = new ClipboardItem({
          "text/html": new Blob([html], {type:"text/html"}),
          "text/plain": new Blob([text], {type:"text/plain"})
        });
        await navigator.clipboard.write([item]);
        setStatus("已复制富文本（粘贴可保留格式）。","ok");
        return;
      }
    }catch(e){}

    const ok = await copyToClipboardText(text || htmlToText(html));
    setStatus(ok ? "已复制（不支持富文本复制，已退化为纯文本）。" : "复制失败，请手动选中复制。", ok ? "warn" : "warn");
  }

  // ---------- Right view switching ----------
  function setRightView(which){
    const map = {preview:viewPreview, export:viewExport, import:viewImport};
    Object.keys(map).forEach(k=> map[k].classList.toggle("active", k===which));
    segPreview.classList.toggle("active", which==="preview");
    segExport.classList.toggle("active", which==="export");
    segImport.classList.toggle("active", which==="import");
  }

  // ---------- Import/Export JSON (file) ----------
  function stripRuntimeForExport(s){
    return normalizeState(JSON.parse(JSON.stringify(s)));
  }

  function downloadText(filename, content, mime="text/plain;charset=utf-8"){
    const blob = new Blob([content], {type:mime});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }

  function downloadProgressJson(){
    const txt = JSON.stringify(stripRuntimeForExport(state), null, 2);
    downloadText("forumbuilder_progress.json", txt, "application/json;charset=utf-8");
    setStatus("已下载进度 JSON。","ok");
  }

  async function importFromSelectedFile(){
    const f = importJsonFile && importJsonFile.files ? importJsonFile.files[0] : null;
    if(!f){ setStatus("请先选择 JSON 文件。","warn"); return; }
    try{
      const text = await f.text();
      const obj = JSON.parse(text);
      state = normalizeState(obj);
      lastActiveIndex = 0;
      ensureSelLength();
      saveState();
      applyStateToUI();
      refreshAll();
      setStatus("已导入并覆盖当前进度。","ok");
    }catch(e){
      setStatus("导入失败：文件不是合法 JSON。","warn");
    }
  }

  // ---------- Wizard events ----------
  btnOpenWiz.addEventListener("click", openWizard);
  btnCloseWiz.addEventListener("click", closeWizard);

  wizStyle.addEventListener("change", buildWizPreview);
  wizExport.addEventListener("change", buildWizPreview);
  wizFields.addEventListener("change", buildWizPreview);
  wizCustomPostTpl.addEventListener("input", buildWizPreview);
  wizShowYear.addEventListener("change", buildWizPreview);
  wizClockMode.addEventListener("change", buildWizPreview);
  wizAutoId.addEventListener("change", buildWizPreview);

  btnResetWiz.addEventListener("click", ()=>{
    state.config = defaultConfig();
    openWizard();
  });

  btnApplyWiz.addEventListener("click", ()=>{
    const temp = getWizTempConfig();
    state.config.style = temp.style;
    state.config.exportMode = temp.exportMode;
    state.config.fields = temp.fields;
    state.config.customPostTemplate = temp.customPostTemplate;
    state.config.time = temp.time;
    state.config.autoId = temp.autoId;

    closeWizard();
    setStatus("已应用设置。","ok");
    updateTopBadges();
    refreshAll();
  });

  wizardMask.addEventListener("mousedown", (e)=>{
    if(e.target === wizardMask) closeWizard();
  });

  // ---------- Top actions ----------
  inpTitle.addEventListener("input", ()=>{
    state.title = inpTitle.value;
    debounceAutosave();
    markExportDirty();
  });

  btnRender.addEventListener("click", ()=>{ refreshAll(); });

  btnDownload.addEventListener("click", ()=>{
    const mode = state.config.exportMode;
    const content = outText.value;
    const filename = mode === "ao3_html" ? "ao3_forum_snippet.html" : "forum.txt";
    const type = mode === "ao3_html" ? "text/html;charset=utf-8" : "text/plain;charset=utf-8";
    downloadText(filename, content, type);
    setStatus("已下载当前内容。","ok");
  });

  btnSave.addEventListener("click", ()=>{ if(saveState()) setStatus("已保存到本地。","ok"); });

  btnNew.addEventListener("click", ()=>{
    state = defaultState();
    lastActiveIndex = 0;
    saveState();
    applyStateToUI();
    updateTopBadges();
    updateRandBadge();
    renderPosts();
    previewEl.innerHTML = "";
    outText.value = "";
    exportHint.textContent = "新帖子已创建：请先点“更改设置”选择结构/字段/导出/时间/随机ID，然后点“应用并进入编辑”。";
    setStatus("已开始新帖子：请重新选择初始化设置。","ok");
    openWizard();
  });

  // --------- Time module events ---------
  btnApplyFirstTime.addEventListener("click", ()=>{
    const v = String(inpFirstTime.value||"").trim();
    if(!v){ setStatus("请先输入首楼时间。","warn"); return; }
    if(!parseTime(v)){ setStatus("首楼时间格式不合法，请按当前时间格式输入。","warn"); return; }

    if(state.options.locked){
      unlockTimes(true);
      updateTopBadges();
    }

    state.posts[0].time = v;
    lastActiveIndex = 0;
    debounceAutosave();
    applyTimeValidity(0, v);
    markExportDirty("已写入首楼时间（锚点），点击“生成 / 刷新预览”更新导出与预览。");
  });

  optRandomTime.addEventListener("change", ()=>{
    state.options.randomTimeEnabled = !!optRandomTime.checked;
    debounceAutosave();
    updateTopBadges();
    markExportDirty("时间设置已更改，点击“生成 / 刷新预览”更新导出与预览。");
  });
  optMinSec.addEventListener("input", ()=>{
    normalizeTimeOptions();
    debounceAutosave();
    markExportDirty("时间范围已更改，点击“生成 / 刷新预览”更新导出与预览。");
  });
  optMaxSec.addEventListener("input", ()=>{
    normalizeTimeOptions();
    debounceAutosave();
    markExportDirty("时间范围已更改，点击“生成 / 刷新预览”更新导出与预览。");
  });

  btnLockTimes.addEventListener("click", ()=>{ lockTimes(); setStatus("已生成并锁定时间。","ok"); });
  btnRerollTimes.addEventListener("click", ()=>{ rerollTimes(); });
  btnUnlockTimes.addEventListener("click", ()=>{ unlockTimes(false); updateTopBadges(); });

  // --------- Bulk module events ---------
  btnSelectAll.addEventListener("click", selectAll);
  btnSelectNone.addEventListener("click", selectNone);

  btnApplySelectedName.addEventListener("click", ()=>{
    const idxs = requireSelected(); if(!idxs) return;
    const changed = applyNameToIndexes(idxs, bulkName.value, !!bulkOverwriteName.checked);
    if(changed){
      debounceAutosave(); renderPosts(); updateTopBadges();
      markExportDirty(`已对已选楼层应用昵称（变更 ${changed} 项），点击“生成 / 刷新预览”更新导出。`);
    }else{
      setStatus("没有产生变更（可能都已有昵称且未勾选覆盖）。","ok");
    }
  });

  btnApplyAllName.addEventListener("click", ()=>{
    const idxs = state.posts.map((_,i)=>i);
    const changed = applyNameToIndexes(idxs, bulkName.value, !!bulkOverwriteName.checked);
    if(changed){
      debounceAutosave(); renderPosts(); updateTopBadges();
      markExportDirty(`已对全部楼层应用昵称（变更 ${changed} 项），点击“生成 / 刷新预览”更新导出。`);
    }else{
      setStatus("没有产生变更（可能都已有昵称且未勾选覆盖）。","ok");
    }
  });

  btnApplySelectedUid.addEventListener("click", ()=>{
    const idxs = requireSelected(); if(!idxs) return;
    const changed = applyUidToIndexes(idxs, bulkUid.value, !!bulkOverwriteUid.checked);
    if(changed){
      debounceAutosave(); renderPosts(); updateTopBadges();
      markExportDirty(`已对已选楼层应用ID（变更 ${changed} 项），点击“生成 / 刷新预览”更新导出。`);
    }else{
      setStatus("没有产生变更（可能都已有ID且未勾选覆盖）。","ok");
    }
  });

  btnApplyAllUid.addEventListener("click", ()=>{
    const idxs = state.posts.map((_,i)=>i);
    const changed = applyUidToIndexes(idxs, bulkUid.value, !!bulkOverwriteUid.checked);
    if(changed){
      debounceAutosave(); renderPosts(); updateTopBadges();
      markExportDirty(`已对全部楼层应用ID（变更 ${changed} 项），点击“生成 / 刷新预览”更新导出。`);
    }else{
      setStatus("没有产生变更（可能都已有ID且未勾选覆盖）。","ok");
    }
  });

  btnGenAllIds.addEventListener("click", ()=>{
    const idxs = state.posts.map((_,i)=>i);
    const changed = genIdsForIndexes(idxs, !!bulkOverwriteUid.checked);
    if(changed){
      debounceAutosave(); renderPosts(); updateTopBadges();
      markExportDirty(`已为全部楼层生成随机ID（变更 ${changed} 项），点击“生成 / 刷新预览”更新导出。`);
    }else{
      setStatus("没有产生变更（可能都已有ID且未勾选覆盖）。","ok");
    }
  });

  // ---------- Right panel events ----------
  btnCopyHtml && btnCopyHtml.addEventListener("click", copyHtmlSnippet);
  btnCopyTxt  && btnCopyTxt.addEventListener("click", copyTxtAll);
  btnCopyRich && btnCopyRich.addEventListener("click", copyRichFromPreview);

  segPreview.addEventListener("click", ()=> setRightView("preview"));
  segExport.addEventListener("click",  ()=> setRightView("export"));
  segImport.addEventListener("click",  ()=> setRightView("import"));

  btnExportJsonDownload.addEventListener("click", downloadProgressJson);
  btnImportApply.addEventListener("click", importFromSelectedFile);

  // ---------- selection click (stop summary toggle) ----------
  postsEl.addEventListener("click", (e)=>{
    const t = e.target;
    if(t && t.dataset && t.dataset.sel !== undefined){
      e.preventDefault();
      e.stopPropagation();
      const i = Number(t.dataset.sel);
      if(Number.isFinite(i)){
        ensureSelLength();
        state.ui.selected[i] = !!t.checked;
        debounceAutosave();
        syncSelBadge();
      }
      return;
    }
  }, true);

  // ---------- RTE + post events ----------
  document.addEventListener("click", (e)=>{
    const t = e.target;

    if(t && t.dataset && t.dataset.sum !== undefined){
      const i = Number(t.dataset.sum);
      if(Number.isFinite(i)) lastActiveIndex = i;
      return;
    }

    if(t && t.dataset && t.dataset.del !== undefined){
      const i = Number(t.dataset.del);
      state.posts.splice(i,1);
      if(state.options.locked && Array.isArray(state.options.lockedTimes)) state.options.lockedTimes.splice(i,1);
      ensureSelLength();
      state.ui.selected.splice(i,1);
      if(lastActiveIndex >= state.posts.length) lastActiveIndex = Math.max(0, state.posts.length-1);
      refreshAll();
      return;
    }

    if(t && t.dataset && t.dataset.genid !== undefined){
      const i = Number(t.dataset.genid);
      genIdForPost(i);
      return;
    }

    if(t && t.dataset && t.dataset.insertbelow !== undefined){
      const i = Number(t.dataset.insertbelow);
      lastActiveIndex = i;
      insertPostBelow(i);
      return;
    }

    if(t && t.dataset && t.dataset.rtecmd){
      const cmd = t.dataset.rtecmd;
      if(cmd === "insertLineBreak") rteCommand("insertHTML", "<br>");
      else rteCommand(cmd);
      markExportDirty();
    }
    if(t && t.dataset && t.dataset.rtelink){ rteLink(); markExportDirty(); }
    if(t && t.dataset && t.dataset.rteclear){ rteClear(); markExportDirty(); }
  });

  document.addEventListener("focusin", (e)=>{
    const t = e.target;
    if(t && t.dataset && t.dataset.i !== undefined){
      const i = Number(t.dataset.i);
      if(Number.isFinite(i)) lastActiveIndex = i;
    }
    if(t && t.classList && t.classList.contains("rte")) activeRte = t;
  });

  document.addEventListener("input", (e)=>{
    const t = e.target;

    if(t && t.dataset && t.dataset.k){
      const i = Number(t.dataset.i);
      const k = t.dataset.k;
      if(Number.isFinite(i)) lastActiveIndex = i;

      if(k === "hasQuote"){
        state.posts[i].hasQuote = !!t.checked;
        debounceAutosave();
        refreshAll();
        markExportDirty("引用开关已更改，点击“生成 / 刷新预览”更新导出。");
        return;
      }

      state.posts[i][k] = t.value;
      debounceAutosave();

      if(k === "time"){
        applyTimeValidity(i, t.value);
        markExportDirty("时间已更改，点击“生成 / 刷新预览”更新导出。");
        return;
      }

      markExportDirty();
      return;
    }

    if(t && t.id === "inpBulkAddCount"){
      // clamp input live
      const v = clampNum(Math.floor(+t.value), 2, 100);
      t.value = String(v);
      return;
    }

    if(t && t.dataset && t.dataset.rte){
      const i = Number(t.dataset.i);
      if(Number.isFinite(i)) lastActiveIndex = i;
      const kind = t.dataset.rte;
      if(kind === "quote") state.posts[i].quoteHtml = t.innerHTML;
      if(kind === "body") state.posts[i].bodyHtml = t.innerHTML;
      debounceAutosave();
      markExportDirty();
    }
  });

  function applyStateToUI(){
    inpTitle.value = state.title || "";
    optRandomTime.checked = !!state.options.randomTimeEnabled;
    optMinSec.value = state.options.minSec ?? 5;
    optMaxSec.value = state.options.maxSec ?? 45;

    inpFirstTime.value = (state.posts[0]?.time || "");
    inpFirstTime.placeholder = getTimePlaceholder();

    // init bulk add input
    if(inpBulkAddCount){
      const v = clampNum(Math.floor(+inpBulkAddCount.value || 2), 2, 100);
      inpBulkAddCount.value = String(v);
    }

    ensureSelLength();
    syncSelBadge();
  }

  // boot
  ensureSelLength();
  const had = !!localStorage.getItem(STORAGE_KEY);
  applyStateToUI();
  updateTopBadges();
  updateRandBadge();
  renderPosts();

  if(had){
    refreshAll();
    setStatus("已从本地恢复上次编辑。","ok");
  } else {
    setStatus("第一次建议点“更改设置”选择字段与结构（含 Custom）。","ok");
    openWizard();
  }

  // append button
  btnAdd.addEventListener("click", ()=>{ appendPost(); });

  // bulk append button
  btnBulkAdd.addEventListener("click", ()=>{
    const n = clampNum(Math.floor(+inpBulkAddCount.value), 2, 100);
    inpBulkAddCount.value = String(n);
    bulkAppendPosts(n);
  });

  // allow Enter on bulk add input
  inpBulkAddCount.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      e.preventDefault();
      btnBulkAdd.click();
    }
  });

  // Right view default
  setRightView("preview");

  /* ==========================
     手机 Dock + Tab + 右侧面板联动
     ========================== */
  const appDock = document.getElementById("appDock");
  const tabEdit = document.getElementById("tabEdit");
  const tabPreview = document.getElementById("tabPreview");
  const tabExport = document.getElementById("tabExport");
  const tabImport = document.getElementById("tabImport");
  const dockRender = document.getElementById("dockRender");
  const dockWiz = document.getElementById("dockWiz");
  const dockCopyHtml = document.getElementById("dockCopyHtml");
  const dockCopyTxt = document.getElementById("dockCopyTxt");
  const dockCopyRich = document.getElementById("dockCopyRich");

  function isMobileUI(){ return window.matchMedia("(max-width: 768px)").matches; }

  function setMobileTab(v){
    if(v === "edit"){
      document.body.dataset.view = "edit";
    } else {
      document.body.dataset.view = "preview";
    }

    tabEdit.classList.toggle("active", v==="edit");
    tabPreview.classList.toggle("active", v==="preview");
    tabExport.classList.toggle("active", v==="export");
    tabImport.classList.toggle("active", v==="import");

    if(v === "preview") setRightView("preview");
    if(v === "export")  setRightView("export");
    if(v === "import")  setRightView("import");

    if(v !== "edit") refreshAll();
  }

  function syncDockVisibility(){
    const on = isMobileUI();
    if(appDock) appDock.style.display = on ? "block" : "none";
    if(on && !document.body.dataset.view) document.body.dataset.view = "edit";
  }

  tabEdit && tabEdit.addEventListener("click", ()=> setMobileTab("edit"));
  tabPreview && tabPreview.addEventListener("click", ()=> setMobileTab("preview"));
  tabExport && tabExport.addEventListener("click", ()=> setMobileTab("export"));
  tabImport && tabImport.addEventListener("click", ()=> setMobileTab("import"));

  dockRender && dockRender.addEventListener("click", ()=> btnRender.click());
  dockWiz && dockWiz.addEventListener("click", ()=> btnOpenWiz.click());

  dockCopyHtml && dockCopyHtml.addEventListener("click", copyHtmlSnippet);
  dockCopyTxt && dockCopyTxt.addEventListener("click", copyTxtAll);
  dockCopyRich && dockCopyRich.addEventListener("click", copyRichFromPreview);

  window.addEventListener("resize", syncDockVisibility);
  syncDockVisibility();

})();
</script>
</body>
</html>
